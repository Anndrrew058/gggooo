<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂÜíÈö™ËÄÖÊóÖÁ®ã - V43 ÊâãÊ©üÈÅ©ÊáâÁâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root { --p: #14b8a6; --bg: #020617; --c: #1e293b; --t: #f1f5f9; }
        .theme-dark-teal { --p: #14b8a6; --bg: #020617; --c: #1e293b; --t: #f1f5f9; }
        .theme-dark-pink { --p: #f472b6; --bg: #0f172a; --c: #1a1b2e; --t: #fce7f3; }
        .theme-dark-gold { --p: #fbbf24; --bg: #1c1917; --c: #292524; --t: #fef3c7; }
        .theme-dark-blue { --p: #3b82f6; --bg: #020617; --c: #1e293b; --t: #eff6ff; }
        .theme-light-mint { --p: #059669; --bg: #f0fdf4; --c: #ffffff; --t: #064e3b; }
        .theme-light-lavender { --p: #8b5cf6; --bg: #f5f3ff; --c: #ffffff; --t: #2e1065; }
        .theme-light-sky { --p: #0ea5e9; --bg: #f0f9ff; --c: #ffffff; --t: #0c4a6e; }
        .theme-light-clay { --p: #d97706; --bg: #fffbeb; --c: #ffffff; --t: #451a03; }

        body { background-color: var(--bg); color: var(--t); transition: all 0.5s; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { background-color: var(--c); border: 1px solid rgba(255,255,255,0.05); }
        .bg-primary { background-color: var(--p); }
        .text-primary { color: var(--p); }
        .border-primary { border-color: var(--p); }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); }
        
        .tooltip-content { opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; }
        .group:hover .tooltip-content { opacity: 1; visibility: visible; }
        
        .boss-card { border-color: #ef4444; background: linear-gradient(145deg, rgba(30,41,59,1) 0%, rgba(69,10,10,0.4) 100%); }
        .boss-icon { filter: drop-shadow(0 0 5px #ef4444); }
        
        @keyframes action-pop { 0% { transform: scale(1); } 50% { transform: scale(1.4); filter: brightness(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: action-pop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .shake { animation: shake 0.4s ease-in-out; }
        .damage-shake { animation: damage 0.2s ease-in-out; }
        @keyframes damage { 0% { transform: translate(0,0) rotate(0deg); } 25% { transform: translate(5px, 5px) rotate(5deg); } 50% { transform: translate(-5px, -5px) rotate(-5deg); } 75% { transform: translate(5px, -5px) rotate(5deg); } 100% { transform: translate(0,0) rotate(0deg); } }
        
        @keyframes slide-up { 0% { transform: translate(-50%, 100%); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        select { -webkit-appearance: none; -moz-appearance: none; text-indent: 1px; text-overflow: ''; }
        
        /* Mobile Input Fix */
        input, select, button { font-size: 16px; } 
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => {
            const commonProps = { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className };
            if (name === 'ChevronDown') return <svg {...commonProps}><path d="m6 9 6 6 6-6"/></svg>;
            if (name === 'ChevronUp') return <svg {...commonProps}><path d="m18 15-6-6-6 6"/></svg>;
            if (name === 'Plus') return <svg {...commonProps}><path d="M5 12h14"/><path d="M12 5v14"/></svg>;
            if (name === 'Trash2') return <svg {...commonProps}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
            if (name === 'CheckSquare') return <svg {...commonProps}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>;
            if (name === 'Square') return <svg {...commonProps}><rect width="18" height="18" x="3" y="3" rx="2"/></svg>;
            if (name === 'Calendar') return <svg {...commonProps}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
            if (name === 'Edit3') return <svg {...commonProps}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>;
            if (name === 'Lock') return <svg {...commonProps}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>;
            if (name === 'X') return <svg {...commonProps}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
            if (name === 'Archive') return <svg {...commonProps}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>;
            if (name === 'Sword') return <svg {...commonProps}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>;
            if (name === 'AlertCircle') return <svg {...commonProps}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
            if (name === 'Bell') return <svg {...commonProps}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>;
            return null;
        };

        const THEMES = [
            { id: 'theme-dark-teal', color: '#14b8a6' }, { id: 'theme-dark-pink', color: '#f472b6' },
            { id: 'theme-dark-gold', color: '#fbbf24' }, { id: 'theme-dark-blue', color: '#3b82f6' },
            { id: 'theme-light-mint', color: '#059669' }, { id: 'theme-light-lavender', color: '#8b5cf6' },
            { id: 'theme-light-sky', color: '#0ea5e9' }, { id: 'theme-light-clay', color: '#d97706' }
        ];

        const AVATARS = ["‚öîÔ∏è", "üèπ", "üßô", "üõ°Ô∏è", "üêâ", "üê∫", "ü¶Ö", "üíé"];

        const ENCOUNTER_DB = [
            { title: "Âπ∏ÈÅãÁöÑÁôºÁèæ", desc: "‰Ω†Âú®ËàäÂ§ñÂ•óÂè£Ë¢ãË£°ÁôºÁèæ‰∫ÜÁö∫Â∑¥Â∑¥ÁöÑÁ¥ôÂπ£ÔºÅ", icon: "üí∞", reward: { gold: 100 }, text: "ÁúüÊòØÂÄãÂ•ΩÂÖÜÈ†≠ÔºÅ" },
            { title: "ÊµÅÊµ™ÂïÜ‰∫∫", desc: "‰∏Ä‰ΩçÁ•ûÁßòÁöÑÂïÜ‰∫∫Ë∑ØÈÅéÔºåÈÄÅ‰∫Ü‰Ω†‰∏ÄÁì∂Ë©¶ÂñùËó•Ê∞¥„ÄÇ", icon: "üßô‚Äç‚ôÇÔ∏è", reward: { potions: { red: 1 } }, text: "Ë¨ùË¨ù‰Ω†ÁöÑÊÖ∑ÊÖ®ÔºÅ" },
            { title: "Á™ÅÂ¶ÇÂÖ∂‰æÜÁöÑÊö¥Èõ®", desc: "‰∏ÄÂ†¥Â§ßÈõ®Êää‰Ω†Ê∑ãÊàê‰∫ÜËêΩÊπØÈõûÔºå‰ΩÜ‰πüËÆì‰Ω†Êõ¥Ê∏ÖÈÜí‰∫Ü„ÄÇ", icon: "üåßÔ∏è", reward: { energy: -10, exp: 50 }, text: "ÈÄô‰πüÊòØ‰∏ÄÁ®Æ‰øÆË°å..." },
            { title: "Ë≤ìÂí™ÁöÑÁ¶ÆÁâ©", desc: "‰Ω†ÁöÑÂÆàË≠∑Áç∏‰∏çÁü•ÂæûÂì™Âèº‰æÜ‰∫Ü‰∏ÄÂÄãÂ•áÊÄ™ÁöÑÊù±Ë•ø...Â•ΩÂÉèÊòØËÇ•ÊñôÔºü", icon: "üêæ", reward: { items: { fertilizer: 1 } }, text: "ÂëÉ...Ë¨ùË¨ù‰Ω†Ôºü" },
            { title: "ÈùàÊÑüÊπßÁèæ", desc: "ËÖ¶‰∏≠Á™ÅÁÑ∂ÈñÉÈÅé‰∏ÄÂÄãÁµïÂ¶ôÁöÑÈªûÂ≠êÔºÅ", icon: "üí°", reward: { exp: 100 }, text: "Âø´Ë®ò‰∏ã‰æÜÔºÅ" },
            { title: "ÁæéÂë≥ÁöÑ‰æøÁï∂", desc: "‰ªäÂ§©ÁöÑÂçàÈ§êÁâπÂà•Â•ΩÂêÉÔºåÂÖÖÊªø‰∫ÜÂäõÈáèÔºÅ", icon: "üç±", reward: { energy: 50 }, text: "Ê≠ê‰ºäÁ≥ªÔºÅ" },
            { title: "ËÆÄÊõ∏ÊúÉ", desc: "ÂèÉÂä†‰∫Ü‰∏ÄÂ†¥ÊúâË∂£ÁöÑË¨õÂ∫ßÔºåÂ≠∏Âà∞‰∫ÜÊñ∞Áü•Ë≠ò„ÄÇ", icon: "üìö", reward: { exp: 150 }, text: "Áü•Ë≠òÂ∞±ÊòØÂäõÈáè„ÄÇ" }
        ];

        const DAILY_REMINDERS = [
            { id: 'water', text: "üíß Ë©≤ÂñùÊ∞¥ÂõâÔºÅ", interval: 90 * 60 * 1000, reward: { energy: 10, exp: 10 } },
            { id: 'eye', text: "üëÄ ‰ºëÊÅØÁúºÁùõÔºÅ", interval: 45 * 60 * 1000, reward: { energy: 5, exp: 5 } },
            { id: 'stretch', text: "üôÜ‚Äç‚ôÇÔ∏è ‰º∏Â±ïÁ≠ãÈ™®ÔºÅ", interval: 180 * 60 * 1000, reward: { energy: 15, exp: 15 } }
        ];

        const PET_SPECIES = {
            cat: { name: 'Ë≤ìÂí™', icon: 'üê±', desc: 'ÈùàÊ¥ªÂÑ™ÈõÖ', evolutions: { A: { name: 'ÁôΩËôéÁ•ûÁç∏', icon: 'üêØ', desc: 'Êà∞Á•û' }, B: { name: '‰πùÂëΩË≤ìÂ¶ñ', icon: 'üêà‚Äç‚¨õ', desc: 'ÈùàË≤ì' } } },
            dog: { name: 'ÁãóÁãó', icon: 'üê∂', desc: 'Âø†Ë™†ÂãáÊï¢', evolutions: { A: { name: 'Â§©ÁãºÊòü', icon: 'üê∫', desc: 'ÈäÄÁâô' }, B: { name: 'Âú∞ÁçÑÁä¨', icon: 'üêï', desc: 'ÂÆàË≠∑ËÄÖ' } } },
            wolf: { name: 'Â≠§Áãº', icon: 'üê∫', desc: 'ËçíÈáéÁçµÊâã', evolutions: { A: { name: 'Ëä¨ÈáåÁàæ', icon: 'üå™Ô∏è', desc: 'ÂêûÂô¨ËÄÖ' }, B: { name: 'ÂÜ∞ÂéüÁãº', icon: '‚ùÑÔ∏è', desc: '‰∏ªÂÆ∞' } } },
            fox: { name: 'ÁãêÁã∏', icon: 'ü¶ä', desc: 'ËÅ∞ÊòéÁã°Èª†', evolutions: { A: { name: '‰πùÂ∞æÂ§©Áãê', icon: 'üî•', desc: 'Â¶ñÁ•û' }, B: { name: 'Á®ªËç∑Á•û‰Ωø', icon: '‚õ©Ô∏è', desc: 'Ë≤°ÂØå' } } },
            owl: { name: 'Ë≤ìÈ†≠È∑π', icon: 'ü¶â', desc: 'Â§úË¶ñÂçÉÈáå', evolutions: { A: { name: 'ÊöóÂ§ú‰∏ªÂÆ∞', icon: 'üåë', desc: 'ÊöóÊÆ∫ËÄÖ' }, B: { name: 'Êô∫ÊÖßÁ•ûÈ≥•', icon: 'üìú', desc: 'Â≠∏ËÄÖ' } } },
            dragon: { name: 'ÂπºÈæç', icon: 'ü¶é', desc: 'ÊΩõËóèÂäõÈáè', evolutions: { A: { name: 'Â∑¥ÂìàÂßÜÁâπ', icon: 'üêâ', desc: 'ÈæçÁéã' }, B: { name: 'Êèê‰∫ûÈ¶¨Áâπ', icon: 'üê≤', desc: 'Ê∑∑Ê≤å' } } }
        };

        const SHOP_ITEMS = [
            { i: 'dry_food', t: 'item', c: 100, n: 'üç™ ÂØµÁâ©‰πæÁ≥ß', desc: 'ÊÅ¢Âæ©Â∞ëË®±È£ΩÈ£ü„ÄÇ' },
            { i: 'food', t: 'item', c: 450, n: 'ü•© ÂÑ™Ë≥™ËÇâÂ°ä', desc: 'Â§ßÂπÖÊÅ¢Âæ©È£ΩÈ£ü„ÄÇ' },
            { i: 'canned_food', t: 'item', c: 800, n: 'üêü ÁâπÁ¥öÁΩêÈ†≠', desc: 'ÊÅ¢Âæ©È£ΩÈ£üËàáÂøÉÊÉÖ„ÄÇ' },
            { i: 'cat_nip', t: 'item', c: 300, n: 'üåø Ë≤ìËçâ/ËàíÁ∑©Ëçâ', desc: 'ÊÅ¢Âæ©ÂøÉÊÉÖ„ÄÇ' },
            { i: 'fertilizer', t: 'item', c: 250, n: 'üí© ÁâπË≥™ËÇ•Êñô', desc: 'Âä†ÈÄüÊ§çÁâ©ÁîüÈï∑„ÄÇ' },
            { i: 'toy', t: 'item', c: 150, n: 'üß∂ ÈÄóË≤ìÊ£í', desc: 'Â¢ûÂä†Ë¶™ÂØÜÂ∫¶„ÄÇ' },
            { i: 'bandage', t: 'item', c: 200, n: 'ü©π ÈÜ´ÁôÇÁπÉÂ∏∂', desc: 'Ê≤ªÁôÇËºïÂÇ∑„ÄÇ' },
            { i: 'med_kit', t: 'item', c: 1500, n: 'üöë ÊÄ•ÊïëÁÆ±', desc: 'Ê≤ªÁôÇÈáçÂÇ∑„ÄÇ' },
            { i: 'red', t: 'potion', c: 300, n: 'üß™ ÁîüÂëΩËó•Âäë', desc: 'ÊÅ¢Âæ©Áé©ÂÆ∂ËÉΩÈáè„ÄÇ' },
            { i: 'gold', t: 'potion', c: 1200, n: 'üß™ ÈªûÈáëËó•Âäë', desc: 'ËÉΩÈáèÊèõÈáëÂπ£„ÄÇ' },
            { i: 'purple', t: 'potion', c: 2000, n: 'üß™ Ë≥¢ËÄÖËó•Âäë', desc: 'Áç≤ÂæóÁ∂ìÈ©óÂÄº„ÄÇ' },
        ];

        const ADVENTURE_LOCATIONS = [
            { id: 'forest', name: 'Ëø∑ÈúßÊ£ÆÊûó', time: 2, cost: 20, loot: ['forest_card', 'ancient_coin', 'leaf_charm'] },
            { id: 'beach', name: 'ÈôΩÂÖâÊ≤ôÁÅò', time: 4, cost: 40, loot: ['beach_card', 'shell_necklace', 'pearl'] },
            { id: 'ruins', name: 'Âè§ËÄÅÈÅ∫Ë∑°', time: 8, cost: 80, loot: ['ruins_card', 'dragon_scale', 'stone_tablet'] }
        ];

        const COLLECTION_DB = {
            'forest_card': { name: 'Ê£ÆÊûóÊòé‰ø°Áâá', type: 'postcard', icon: 'üå≤', desc: 'ËåÇÂØÜÁöÑÊ£ÆÊûóÊ∑±Ëôï„ÄÇ' },
            'beach_card': { name: 'Êµ∑ÁÅòÊòé‰ø°Áâá', type: 'postcard', icon: 'üèñÔ∏è', desc: 'ÈôΩÂÖâÊôÆÁÖßÁöÑÊ≤ôÁÅò„ÄÇ' },
            'ruins_card': { name: 'ÈÅ∫Ë∑°Êòé‰ø°Áâá', type: 'postcard', icon: 'üèõÔ∏è', desc: 'Âè§ÊñáÊòéÁöÑÊÆòÂû£Êñ∑Â£Å„ÄÇ' },
            'ancient_coin': { name: 'Âè§ËÄÅÁ°¨Âπ£', type: 'artifact', icon: 'ü™ô', desc: 'ÂàªÊúâÊú™Áü•ÊñáÂ≠ó„ÄÇ' },
            'leaf_charm': { name: 'ËëâÂ≠êË≠∑Á¨¶', type: 'artifact', icon: 'üçÉ', desc: 'Á∑®ÁπîÁ≤æÁæé„ÄÇ' },
            'shell_necklace': { name: 'Ë≤ùÊÆºÈ†ÖÈçä', type: 'artifact', icon: 'üêö', desc: 'ÁæéÈ∫óÁöÑË≤ùÊÆº„ÄÇ' },
            'pearl': { name: 'ÂÖâÊæ§ÁèçÁè†', type: 'artifact', icon: '‚ö™', desc: 'ÂúìÊΩ§È£ΩÊªø„ÄÇ' },
            'dragon_scale': { name: 'Èæç‰πãÈ±óÁâá', type: 'artifact', icon: 'üê≤', desc: 'ÂæÆÁÜ±ÁöÑÈ±óÁâá„ÄÇ' },
            'stone_tablet': { name: 'Áü≥ÊùøÁ¢éÁâá', type: 'artifact', icon: 'ü™®', desc: 'Ë®òËºâËëóÈ†êË®Ä„ÄÇ' }
        };

        const LocalDatabase = {
            categories: [
                { type: 'ÂäõÈáè', icon: '‚öîÔ∏è', keywords: ['Ë∑ë', 'ÂÅ•Ë∫´', 'ÊâìÁêÉ', 'ÈÅãÂãï', 'Áà¨Â±±', 'Ë®ìÁ∑¥', 'ÈáçË®ì', 'Ëµ∞'] },
                { type: 'Êô∫ÊÖß', icon: 'üîÆ', keywords: ['Â≠∏', 'ËÆÄ', 'ÂØ´', 'Ë™≤', 'ËÄÉ', 'Á†îÁ©∂', 'Á∑®Á®ã', 'Â∑•‰Ωú', 'Â†±Âëä', 'ÊúÉË≠∞'] },
                { type: 'ÈùàÈ≠Ç', icon: '‚ú®', keywords: ['ÂÜ•ÊÉ≥', 'Áù°', '‰ºëÊÅØ', 'ÊîæÈ¨Ü', 'Èü≥Ê®Ç', 'ÈùúÂùê', 'Á¶±Âëä', 'ÁëúÁèà'] },
                { type: 'Á§æ‰∫§', icon: 'ü§ù', keywords: ['ËÅöÊúÉ', 'ËÅä', 'ÈõªË©±', 'Ë¶ãÈù¢', 'Á¥ÑÊúÉ', 'Èô™‰º¥', 'ÂÆ∂', 'Âèã'] },
                { type: 'ÁîüÊ¥ª', icon: 'üè†', keywords: ['Ê¥ó', 'ÊéÉ', 'Ë≤∑', 'ÁÖÆ', 'ÂêÉ', 'Êï¥ÁêÜ', 'ÂûÉÂúæ', 'Ëä±', 'Áπ≥Ë≤ª'] }
            ],
            autoClassify: (text) => {
                for (let cat of LocalDatabase.categories) {
                    if (cat.keywords.some(k => text.includes(k))) return { type: cat.type, icon: cat.icon };
                }
                return { type: 'Êó•Â∏∏', icon: 'üìú' };
            }
        };

        const SoundEngine = {
            play: (type) => {
                const sounds = {
                    click: 'https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3',
                    success: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                    fail: 'https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3',
                    potion: 'https://assets.mixkit.co/active_storage/sfx/611/611-preview.mp3',
                    water: 'https://assets.mixkit.co/active_storage/sfx/1118/1118-preview.mp3',
                    eat: 'https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3',
                    subtask: 'https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3',
                    meow: 'https://assets.mixkit.co/active_storage/sfx/3004/3004-preview.mp3',
                    harvest: 'https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3',
                    attack: 'https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3',
                    victory: 'https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3',
                    notification: 'https://assets.mixkit.co/active_storage/sfx/2865/2865-preview.mp3'
                };
                try {
                    const audio = new Audio(sounds[type]);
                    audio.volume = 0.4;
                    const playPromise = audio.play();
                    if (playPromise !== undefined) { playPromise.catch(error => {}); }
                } catch(e) {}
            }
        };

        const GrowthSystem = {
            getTreeStage: (exp) => {
                if (exp < 10) return { icon: 'üå±', name: 'ÂπºËãóÊúü', nextExp: 10 };
                if (exp < 50) return { icon: 'üåø', name: 'ÊàêÈï∑Êúü', nextExp: 50 };
                return { icon: 'üå≥', name: 'Á•ûÊú®Êúü', nextExp: null };
            },
            getPetStage: (exp, type = 'cat', divinePath = null) => {
                const speciesData = PET_SPECIES[type] || PET_SPECIES['cat'];
                if (exp < 15) return { icon: speciesData.icon, name: `ÂπºÂπ¥${speciesData.name}`, nextExp: 15 };
                if (exp < 100) return { icon: speciesData.icon, name: `ÊàêÂπ¥${speciesData.name}`, nextExp: 100 };
                if (divinePath && speciesData.evolutions[divinePath]) {
                    const evo = speciesData.evolutions[divinePath];
                    return { icon: evo.icon, name: evo.name, nextExp: null };
                }
                return { icon: speciesData.icon, name: `Á•ûÁç∏${speciesData.name}`, nextExp: null };
            }
        };

        const Tooltip = ({ content, children, position = 'top' }) => (
            <div className="group relative flex items-center justify-center">
                {children}
                <div className={`tooltip-content absolute ${position === 'bottom' ? 'top-full mt-2' : 'bottom-full mb-2'} w-max max-w-[200px] bg-slate-800 border border-primary/30 text-xs rounded-lg p-3 shadow-xl z-50 pointer-events-none text-left`}>
                    {content}
                </div>
            </div>
        );

        const Modal = ({ title, children, onClose, width = 'max-w-sm' }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                <div className={`bg-slate-800 border-2 border-primary rounded-2xl p-6 w-[95%] ${width} shadow-2xl relative animate-pop max-h-[90vh] overflow-y-auto`}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white/50 hover:text-white z-10"><Icon name="X" /></button>
                    <h3 className="text-xl font-bold text-primary mb-4 text-center">{title}</h3>
                    {children}
                </div>
            </div>
        );

        const BulkInput = ({ value, onChange }) => (
            <div className="flex items-center gap-1 bg-black/20 px-2 py-1 rounded-lg text-xs border border-white/5">
                <span className="opacity-50">ÊâπÈáè</span>
                <select value={value} onChange={(e) => onChange(parseInt(e.target.value))} className="bg-transparent text-center outline-none font-bold cursor-pointer appearance-none text-right pr-1" style={{textAlignLast: 'center'}}>
                    <option value={1} className="bg-slate-800 text-white">x1</option>
                    {[5, 10, 50].map(num => <option key={num} value={num} className="bg-slate-800 text-white">x{num}</option>)}
                </select>
            </div>
        );

        function App() {
            const [player, setPlayer] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('v43_p'));
                const defaultData = { 
                    name: 'ÂÜíÈö™ËÄÖ', lv: 1, xp: 0, gold: 500, energy: 100, avatar: "‚öîÔ∏è",
                    potions: { red: 1, gold: 0, purple: 0 }, 
                    items: { fertilizer: 0, food: 0, dry_food: 0, canned_food: 0, cat_nip: 0, toy: 0, fruit: 0, bandage: 0, med_kit: 0 },
                    collection: { postcards: [], artifacts: [] },
                    theme: 'theme-dark-teal',
                    base: {
                        treeName: 'Â∏åÊúõ‰πãÊ®π', treeExp: 0, treeProgress: 0,
                        petName: 'Â∞èÂ§•‰º¥', petExp: 0, petHunger: 80, petMood: 80, petStamina: 100, petType: null, divinePath: null,
                        petStatus: 'idle', adventureEndTime: null, adventureLocation: null, lastUpdate: Date.now()
                    }
                };
                return saved ? { ...defaultData, ...saved, base: { ...defaultData.base, ...saved.base } } : defaultData;
            });
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('v43_t')) || []);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('v43_h')) || []);
            
            const [activeEncounter, setActiveEncounter] = useState(null);
            const [pendingReminders, setPendingReminders] = useState([]);
            const [toast, setToast] = useState(null);
            const [showReminderDropdown, setShowReminderDropdown] = useState(false);
            const reminderRef = useRef(null);

            const [bulkAmount, setBulkAmount] = useState(1);
            const [input, setInput] = useState({ text: '', mode: 'duration', hours: 24, date: '' });
            const [showAvatars, setShowAvatars] = useState(false);
            const [activeAnim, setActiveAnim] = useState(null);
            const [isShaking, setIsShaking] = useState(false);
            const [curTime, setCurTime] = useState(new Date());
            const [expandedTaskId, setExpandedTaskId] = useState(null);
            const [viewMode, setViewMode] = useState('active');
            const [modalConfig, setModalConfig] = useState(null);
            const [tempInput, setTempInput] = useState('');

            const maxEnergy = 100 + (player.lv * 15);
            const maxExp = player.lv * 1000;

            const showToast = (message) => { setToast(message); setTimeout(() => setToast(null), 3000); };
            const formatTime = (ms) => {
                const totalSeconds = Math.max(0, Math.floor(ms / 1000));
                const m = Math.floor(totalSeconds / 60);
                const s = totalSeconds % 60;
                return `${m}ÂàÜ${s}Áßí`;
            };

            useEffect(() => {
                const handleClickOutside = (event) => { if (reminderRef.current && !reminderRef.current.contains(event.target)) setShowReminderDropdown(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = Date.now();
                    if (!activeEncounter && Math.random() < 0.05) {
                        setActiveEncounter(ENCOUNTER_DB[Math.floor(Math.random() * ENCOUNTER_DB.length)]);
                        SoundEngine.play('notification');
                    }
                    const newReminders = [];
                    DAILY_REMINDERS.forEach(reminder => {
                        const lastTrigger = parseInt(localStorage.getItem(`reminder_${reminder.id}`) || '0');
                        if (now - lastTrigger > reminder.interval) {
                            newReminders.push(reminder);
                            localStorage.setItem(`reminder_${reminder.id}`, now.toString());
                        }
                    });
                    if (newReminders.length > 0) {
                        setPendingReminders(prev => [...prev, ...newReminders]);
                        SoundEngine.play('notification');
                    }
                    if (player.base.petStatus === 'exploring' && player.base.adventureEndTime && now >= player.base.adventureEndTime) {
                        completeAdventure();
                    }
                    setPlayer(p => {
                        if (p.lv < 9) return p;
                        if (p.base.petStatus === 'exploring' || p.base.petStatus === 'critical') return p;
                        const newHunger = Math.max(0, p.base.petHunger - 1);
                        const newMood = Math.max(0, p.base.petMood - 1);
                        const newStamina = Math.min(100, p.base.petStamina + 1);
                        let newProgress = p.base.treeProgress;
                        if (newProgress < 100) newProgress += 0.2; 
                        return { ...p, base: { ...p.base, petHunger: newHunger, petMood: newMood, petStamina: newStamina, treeProgress: newProgress } };
                    });
                }, 60000);
                return () => clearInterval(timer);
            }, [activeEncounter, player.base.petStatus, player.base.adventureEndTime]);

            useEffect(() => {
                localStorage.setItem('v43_p', JSON.stringify(player));
                localStorage.setItem('v43_t', JSON.stringify(tasks));
                localStorage.setItem('v43_h', JSON.stringify(history));
                document.body.className = player.theme;
                const timer = setInterval(() => setCurTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, [player, tasks, history]);

            useEffect(() => {
                if (player.lv >= 9 && !player.base.petType && !modalConfig) setModalConfig({ type: 'select_species' });
                else if (player.base.petExp >= 100 && !player.base.divinePath && !modalConfig) setModalConfig({ type: 'evolve_species' });
            }, [player.lv, player.base.petExp, player.base.petType, player.base.divinePath]);

            const addExp = (amt, goldAmt = 0) => {
                setPlayer(p => {
                    let nXp = p.xp + amt, nLv = p.lv, nGold = p.gold + goldAmt, nEnergy = p.energy, nPot = { ...p.potions };
                    while (nXp >= nLv * 1000) { nXp -= nLv * 1000; nLv++; nEnergy += 50; nGold += nLv * 150; nPot.red += 1; confetti(); SoundEngine.play('success'); showToast(`ÂçáÁ¥öÂï¶ÔºÅÁ≠âÁ¥ö ${nLv}`); }
                    return { ...p, xp: nXp, lv: nLv, gold: nGold, energy: nEnergy, potions: nPot };
                });
            };

            const handleMystery = (cmd) => {
                const match = cmd.match(/(exp|gold|hp|all)\((\d+)\)/);
                if (!match && !['reset_pet', 'max_pet', 'trigger_event'].includes(cmd)) return false;
                if (match) {
                    const [_, type, val] = match; const num = parseInt(val);
                    if (type === 'exp' || type === 'all') addExp(num);
                    if (type === 'gold' || type === 'all') setPlayer(p => ({ ...p, gold: p.gold + num }));
                    if (type === 'hp' || type === 'all') setPlayer(p => ({ ...p, energy: Math.min(maxEnergy, p.energy + num) }));
                }
                if (cmd === 'reset_pet') setPlayer(p => ({ ...p, base: { ...p.base, petType: null, petExp: 0, divinePath: null } })); 
                if (cmd === 'max_pet') setPlayer(p => ({ ...p, base: { ...p.base, petExp: 100 } })); 
                if (cmd === 'trigger_event') setActiveEncounter(ENCOUNTER_DB[0]);
                SoundEngine.play('success'); showToast("Êåá‰ª§Â∑≤Âü∑Ë°å"); return true;
            };

            const shopBuy = (item, type, cost) => {
                const quantity = Number(bulkAmount) || 1; const totalCost = cost * quantity;
                if (player.gold >= totalCost) {
                    SoundEngine.play('click');
                    setPlayer(p => {
                        let newP = { ...p, gold: p.gold - totalCost };
                        if (type === 'potion') newP.potions[item] = (newP.potions[item] || 0) + quantity;
                        else newP.items[item] = (newP.items[item] || 0) + quantity;
                        return newP;
                    });
                    showToast(`üõí Ë≥ºË≤∑ÊàêÂäü`);
                } else { setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); showToast(`‚ùå ÈáëÂπ£‰∏çË∂≥`); }
            };

            const usePotion = (type) => {
                 if (player.potions[type] <= 0) return;
                 if (type === 'gold' && player.energy < 30) { setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); return; }
                 SoundEngine.play('potion');
                 setPlayer(p => {
                    let nPot = { ...p.potions, [type]: p.potions[type] - 1 };
                    if (type === 'red') return { ...p, potions: nPot, energy: Math.min(maxEnergy, p.energy + 60) };
                    if (type === 'gold') return { ...p, potions: nPot, gold: p.gold + 1200, energy: p.energy - 30 };
                    if (type === 'purple') { addExp(2500); return { ...p, potions: nPot }; }
                    return p;
                 });
                 showToast(`üß™ ‰ΩøÁî®Ëó•Âäë`);
            };

            const handleBaseAction = (action) => {
                const map = { 'fertilize': 'fertilizer', 'feed': 'food', 'toy': 'toy' };
                const currentStock = player.items[map[action]];
                const amount = Math.min(Number(bulkAmount) || 1, currentStock);

                if (amount > 0) {
                     let updates = {};
                     if (action === 'fertilize') { SoundEngine.play('water'); setActiveAnim('f'); updates = { treeProgress: 25 * amount, treeExp: 2 * amount }; showToast(`üíß ÊñΩËÇ• x${amount}`); }
                     else {
                         SoundEngine.play(action === 'toy' ? 'meow' : 'eat'); setActiveAnim('p');
                         if (action === 'feed') { updates = { petHunger: 40 * amount, petExp: 2 * amount }; showToast(`ü•© È§µÈ£ü x${amount}`); }
                         if (action === 'toy') { setActiveAnim('toy'); updates = { petMood: 30 * amount, petExp: 3 * amount }; showToast(`üß∂ Áé©ËÄç x${amount}`); }
                     }
                     setPlayer(p => {
                         const newItems = { ...p.items, [map[action]]: p.items[map[action]] - amount };
                         let newBase = { ...p.base };
                         if (updates.treeProgress) newBase.treeProgress = Math.min(100, newBase.treeProgress + updates.treeProgress);
                         if (updates.treeExp) newBase.treeExp += updates.treeExp;
                         if (updates.petHunger) newBase.petHunger = Math.min(100, newBase.petHunger + updates.petHunger);
                         if (updates.petMood) newBase.petMood = Math.min(100, newBase.petMood + updates.petMood);
                         if (updates.petExp) newBase.petExp += updates.petExp;
                         return { ...p, items: newItems, base: newBase };
                     });
                     setTimeout(() => setActiveAnim(null), 600);
                } else { setIsShaking(true); setTimeout(()=>setIsShaking(false), 400); showToast(`‚ùå ÈÅìÂÖ∑‰∏çË∂≥`); }
            };

            const harvestFruit = () => {
                if (player.base.treeProgress >= 100) {
                    SoundEngine.play('harvest');
                    setPlayer(p => ({ ...p, items: { ...p.items, fruit: p.items.fruit + 1 }, base: { ...p.base, treeProgress: 0 } }));
                    addExp(50); showToast(`üçé Êé°Êî∂ÊàêÂäüÔºÅ`);
                }
            };

            const startAdventure = (locationId) => {
                const location = ADVENTURE_LOCATIONS.find(l => l.id === locationId);
                if (player.base.petStamina < location.cost) { showToast("‚ùå È´îÂäõ‰∏çË∂≥"); return; }
                if (player.base.petStatus !== 'idle') { showToast("‚ùå ÁãÄÊÖã‰∏çÈÅ©Âêà"); return; }
                setPlayer(p => ({ ...p, base: { ...p.base, petStatus: 'exploring', petStamina: p.base.petStamina - location.cost, adventureLocation: locationId, adventureEndTime: Date.now() + (location.time * 60 * 1000) } }));
                setModalConfig(null); showToast(`üéí Âá∫ÁôºÂéª${location.name}ÔºÅ`);
            };

            const completeAdventure = () => {
                const locId = player.base.adventureLocation;
                const location = ADVENTURE_LOCATIONS.find(l => l.id === locId);
                const successChance = (player.base.petMood + player.base.petHunger) / 200; 
                let result = { type: 'success', msg: '', reward: {} };
                if (Math.random() > successChance + 0.1) {
                     result.type = Math.random() < 0.2 ? 'critical' : 'injured';
                     result.msg = result.type === 'critical' ? 'ÈáçÂÇ∑Ê≠∏‰æÜÔºÅ' : 'Âèó‰∫ÜËºïÂÇ∑„ÄÇ';
                } else {
                    result.type = 'success'; result.msg = 'Â∏∂Âõû‰∫ÜÊà∞Âà©ÂìÅÔºÅ';
                    addExp(location.time * 50, location.time * 30);
                    if (Math.random() < 0.3) {
                        const lootItem = location.loot[Math.floor(Math.random() * location.loot.length)];
                        setPlayer(p => {
                            const newCol = { ...p.collection };
                            const list = COLLECTION_DB[lootItem].type === 'postcard' ? newCol.postcards : newCol.artifacts;
                            if (!list.includes(lootItem)) list.push(lootItem);
                            return { ...p, collection: newCol };
                        });
                        result.loot = lootItem;
                    }
                }
                setPlayer(p => ({ ...p, base: { ...p.base, petStatus: result.type === 'success' ? 'idle' : result.type, adventureLocation: null, adventureEndTime: null } }));
                setModalConfig({ type: 'adventure_result', result });
            };

            const treatPet = (method) => {
                if (method === 'bandage' && player.items.bandage > 0) {
                     setPlayer(p => ({ ...p, items: { ...p.items, bandage: p.items.bandage - 1 }, base: { ...p.base, petStatus: 'idle', petMood: p.base.petMood + 20 } }));
                     showToast("ü©π ÂåÖÁ¥ÆÂÆåÊàê");
                } else if (method === 'med_kit' && player.items.med_kit > 0) {
                     setPlayer(p => ({ ...p, items: { ...p.items, med_kit: p.items.med_kit - 1 }, base: { ...p.base, petStatus: 'idle', petStamina: 50 } }));
                     showToast("üöë ÊÄ•ÊïëÊàêÂäü");
                } else showToast("‚ùå ÈÅìÂÖ∑‰∏çË∂≥");
            };

            const handleAddTask = () => {
                if (!input.text) return;
                if (handleMystery(input.text)) { setInput({ ...input, text: '' }); return; }
                const { type, icon } = LocalDatabase.autoClassify(input.text);
                let deadline = input.mode === 'date' && input.date ? new Date(input.date).getTime() : new Date().getTime() + (input.hours * 3600000);
                const finalDurationHours = Math.max(1, Math.floor((deadline - new Date().getTime()) / 3600000));
                const isBoss = finalDurationHours > 72;
                const newTaskId = Date.now();
                setTasks([{ id: newTaskId, content: input.text, type, icon: isBoss ? 'üëπ' : icon, deadline, gold: Math.max(10, finalDurationHours * 50), exp: Math.max(20, finalDurationHours * 100), subtasks: [], isBoss: isBoss }, ...tasks]);
                SoundEngine.play('click'); setInput({ ...input, text: '' }); setExpandedTaskId(newTaskId); showToast(isBoss ? "üëπ BOSS Á¥ö‰ªªÂãôÔºÅ" : "üìú Êñ∞ÂßîË®óÂª∫Á´ã");
            };

            const addSubtask = (taskId, text) => { if (!text.trim()) return; setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), { id: Date.now(), text, completed: false }] } : t)); SoundEngine.play('click'); };
            const toggleSubtask = (taskId, subtaskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (task && task.isBoss) { setActiveAnim(taskId); SoundEngine.play('attack'); setTimeout(() => setActiveAnim(null), 200); addExp(50, 20); } else { SoundEngine.play('subtask'); addExp(20, 10); }
                setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, completed: !st.completed } : st) } : t));
            };
            const removeSubtask = (taskId, subtaskId) => setTasks(tasks.map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t));

            const confirmRename = () => { if (tempInput.trim()) setPlayer(p => ({ ...p, base: { ...p.base, [modalConfig.type === 'rename_tree' ? 'treeName' : 'petName']: tempInput } })); setModalConfig(null); setTempInput(''); };
            const confirmSpecies = (speciesKey) => { setPlayer(p => ({ ...p, base: { ...p.base, petType: speciesKey, petName: PET_SPECIES[speciesKey].name } })); setModalConfig(null); SoundEngine.play('success'); confetti(); };
            const confirmEvolution = (pathKey) => { setPlayer(p => ({ ...p, base: { ...p.base, divinePath: pathKey } })); setModalConfig(null); SoundEngine.play('success'); confetti(); };
            const confirmComplete = (archive) => {
                const task = modalConfig.task;
                addExp(task.exp + (task.isBoss ? 500 : 0));
                setPlayer(p => ({ ...p, gold: p.gold + task.gold + (task.isBoss ? 1000 : 0) }));
                if (archive) setHistory([{ ...task, completedAt: Date.now() }, ...history]);
                setTasks(tasks.filter(t => t.id !== task.id)); setModalConfig(null);
                SoundEngine.play(task.isBoss ? 'victory' : 'success'); confetti(); showToast(`üéâ ‰ªªÂãôÂÆåÊàêÔºÅ`);
            };
            const confirmEncounter = () => {
                const enc = modalConfig.data; const reward = enc.reward || {};
                setPlayer(p => {
                    let newP = { ...p };
                    if (reward.gold) newP.gold += reward.gold; if (reward.energy) newP.energy = Math.min(maxEnergy, newP.energy + reward.energy);
                    if (reward.items) Object.keys(reward.items).forEach(k => { newP.items[k] = (newP.items[k] || 0) + reward.items[k]; });
                    if (reward.potions) Object.keys(reward.potions).forEach(k => { newP.potions[k] = (newP.potions[k] || 0) + reward.potions[k]; });
                    return newP;
                });
                if (reward.exp) addExp(reward.exp);
                setActiveEncounter(null); setModalConfig(null); SoundEngine.play('success'); showToast("Â•áÈÅáÁµêÊùüÔºÅ");
            };

            const handleReminderClick = (index) => {
                const reminder = pendingReminders[index];
                addExp(reminder.reward.exp); setPlayer(p => ({ ...p, energy: Math.min(maxEnergy, p.energy + reminder.reward.energy) }));
                const newReminders = [...pendingReminders]; newReminders.splice(index, 1); setPendingReminders(newReminders);
                SoundEngine.play('success'); confetti(); showToast(`‚úÖ ÂÆåÊàêÊèêÈÜí`);
            };

            const treeStage = GrowthSystem.getTreeStage(player.base.treeExp);
            const petStage = GrowthSystem.getPetStage(player.base.petExp, player.base.petType, player.base.divinePath);

            return (
                <div className={`p-3 md:p-4 min-h-screen ${isShaking ? 'shake' : ''}`}>
                    {toast && <div className="fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-800 border-2 border-primary text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-up z-50 pointer-events-none whitespace-nowrap"><span className="text-xl">‚ú®</span><span className="font-bold text-sm">{toast}</span></div>}

                    {modalConfig && (
                        <Modal title={modalConfig.type === 'adventure' ? 'ÈÅ∏ÊìáÂú∞Èªû' : modalConfig.type === 'adventure_result' ? 'Êé¢Èö™Â†±Âëä' : modalConfig.type === 'collection' ? 'ÂÜíÈö™ÂúñÈëë' : 'Á≥ªÁµ±Ë®äÊÅØ'} onClose={() => { if(modalConfig.type !== 'select_species' && modalConfig.type !== 'evolve_species') setModalConfig(null); }} width={modalConfig.type==='collection'?'max-w-2xl':'max-w-sm'}>
                            {modalConfig.type.includes('rename') && (<div className="space-y-4"><input autoFocus value={tempInput} onChange={e => setTempInput(e.target.value)} className="w-full bg-black/50 p-3 rounded-xl text-center text-lg outline-none border border-primary" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó..." /><button onClick={confirmRename} className="w-full bg-primary py-3 rounded-xl font-bold">Á¢∫Ë™ç</button></div>)}
                            {modalConfig.type === 'adventure' && (<div className="space-y-3"><div className="text-center mb-4"><div className="text-4xl mb-2">{petStage.icon}</div><div className="text-sm opacity-70">È´îÂäõ: {player.base.petStamina}/100</div></div>{ADVENTURE_LOCATIONS.map(loc => (<button key={loc.id} onClick={() => startAdventure(loc.id)} disabled={player.base.petStamina < loc.cost} className="w-full flex justify-between items-center bg-white/5 hover:bg-primary/20 p-3 rounded-xl border border-white/10 disabled:opacity-30"><div className="text-left"><div className="font-bold">{loc.name}</div><div className="text-xs opacity-50">ÈúÄ {loc.time} ÂàÜÈêò</div></div><div className="text-orange-400 font-bold">-{loc.cost} ‚ö°</div></button>))}</div>)}
                            {modalConfig.type === 'adventure_result' && (<div className="text-center space-y-4"><div className="text-6xl animate-bounce">{modalConfig.result.type === 'success' ? 'üéâ' : modalConfig.result.type === 'injured' ? 'ü§ï' : 'üöë'}</div><h3 className="text-xl font-bold">{modalConfig.result.msg}</h3>{modalConfig.result.loot && (<div className="bg-yellow-500/10 p-4 rounded-xl border border-yellow-500/50 animate-pop flex flex-col items-center gap-2"><div className="text-4xl">{COLLECTION_DB[modalConfig.result.loot].icon}</div><div className="font-bold text-yellow-300">{COLLECTION_DB[modalConfig.result.loot].name}</div></div>)}<button onClick={() => setModalConfig(null)} className="w-full bg-primary py-3 rounded-xl font-bold">Áü•ÈÅì‰∫Ü</button></div>)}
                            {modalConfig.type === 'collection' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-[60vh] overflow-y-auto"><div><h4 className="font-bold text-center mb-2 border-b border-white/10 pb-2">Êòé‰ø°Áâá</h4><div className="grid grid-cols-2 gap-2">{player.collection.postcards.map(id => (<div key={id} className="bg-white/10 p-2 rounded-lg text-center"><div className="text-2xl mb-1">{COLLECTION_DB[id].icon}</div><div className="text-xs font-bold">{COLLECTION_DB[id].name}</div></div>))}</div></div><div><h4 className="font-bold text-center mb-2 border-b border-white/10 pb-2">Â•áÁâ©</h4><div className="grid grid-cols-2 gap-2">{player.collection.artifacts.map(id => (<div key={id} className="bg-yellow-500/10 p-2 rounded-lg text-center border border-yellow-500/20"><div className="text-2xl mb-1">{COLLECTION_DB[id].icon}</div><div className="text-xs font-bold text-yellow-200">{COLLECTION_DB[id].name}</div></div>))}</div></div></div>)}
                            {modalConfig.type === 'select_species' && (<div className="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto">{Object.entries(PET_SPECIES).map(([key, data]) => (<button key={key} onClick={() => confirmSpecies(key)} className="bg-white/5 hover:bg-primary/20 p-4 rounded-xl flex flex-col items-center gap-2 border border-white/10"><span className="text-4xl">{data.icon}</span><span className="font-bold">{data.name}</span></button>))}</div>)}
                            {modalConfig.type === 'evolve_species' && player.base.petType && (<div className="grid grid-cols-2 gap-4">{Object.entries(PET_SPECIES[player.base.petType].evolutions).map(([key, data]) => (<button key={key} onClick={() => confirmEvolution(key)} className="bg-slate-700 hover:border-yellow-400 border-2 border-transparent p-4 rounded-xl flex flex-col items-center gap-2"><span className="text-5xl animate-bounce">{data.icon}</span><span className="font-bold text-yellow-400">{data.name}</span></button>))}</div>)}
                            {modalConfig.type === 'encounter' && (<div className="space-y-4 text-center"><div className="text-6xl animate-bounce mb-2">{modalConfig.data.icon}</div><h4 className="text-xl font-bold">{modalConfig.data.title}</h4><p className="text-white/70 text-sm">{modalConfig.data.desc}</p><button onClick={confirmEncounter} className="w-full bg-primary py-3 rounded-xl font-bold mt-2">{modalConfig.data.text}</button></div>)}
                            {modalConfig.type === 'complete_confirm' && (<div className="space-y-4 text-center"><p>ÊÅ≠ÂñúÂÆåÊàê <span className="font-bold text-primary">{modalConfig.task.content}</span>ÔºÅ</p><div className="grid grid-cols-2 gap-3"><button onClick={() => confirmComplete(true)} className="bg-primary py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Icon name="Archive" size={16} /> ÁïôÂ≠ò</button><button onClick={() => confirmComplete(false)} className="bg-red-500/20 text-red-400 py-3 rounded-xl font-bold flex items-center justify-center gap-2"><Icon name="Trash2" size={16} /> Èä∑ÊØÄ</button></div></div>)}
                        </Modal>
                    )}

                    <header className="card max-w-5xl mx-auto p-4 md:p-6 rounded-3xl shadow-2xl border-b-4 border-primary flex flex-col md:flex-row gap-4 md:gap-8 items-center relative overflow-visible">
                        <div className="flex flex-row md:flex-col gap-4 items-center w-full md:w-auto justify-between md:justify-start">
                            <button onClick={() => setShowAvatars(!showAvatars)} className="text-4xl md:text-5xl bg-white/5 p-3 md:p-4 rounded-2xl">{player.avatar}</button>
                            <div className="flex md:flex-wrap gap-1">
                                {THEMES.map(t => <button key={t.id} onClick={()=>setPlayer({...player, theme: t.id})} className="w-4 h-4 rounded-full border border-white/10" style={{background: t.color}} />)}
                            </div>
                            {showAvatars && (<div className="absolute top-20 left-4 z-50 bg-slate-800 p-3 rounded-xl grid grid-cols-4 gap-2 shadow-2xl border border-white/10 w-44">{AVATARS.map(a => <button key={a} onClick={()=>{setPlayer({...player, avatar: a}); setShowAvatars(false);}} className="text-2xl">{a}</button>)}</div>)}
                        </div>

                        <div className="flex-1 space-y-2 w-full">
                            <div className="flex items-center justify-between gap-4">
                                <div className="flex items-center gap-2 md:gap-4">
                                    <input value={player.name} onChange={e => setPlayer({...player, name: e.target.value})} className="bg-transparent font-black text-xl md:text-2xl outline-none border-b border-white/5 focus:border-primary w-28 md:w-40" />
                                    <Tooltip content="Gold" position="bottom"><span className="text-yellow-500 font-bold cursor-help text-sm md:text-base">üí∞ {player.gold}</span></Tooltip>
                                </div>
                                <div className="flex items-center gap-2">
                                    {activeEncounter && (<button onClick={() => setModalConfig({ type: 'encounter', data: activeEncounter })} className="animate-bounce bg-red-500/20 p-2 rounded-full border border-red-500 text-red-400"><Icon name="AlertCircle" size={18} /></button>)}
                                    <div className="relative" ref={reminderRef}>
                                        <button onClick={() => setShowReminderDropdown(!showReminderDropdown)} className={`p-2 rounded-full border ${pendingReminders.length > 0 ? 'bg-blue-500/20 border-blue-500 text-blue-400' : 'border-white/10 text-white/30'}`}><Icon name="Bell" size={18} />{pendingReminders.length > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full text-[10px] flex items-center justify-center text-white">{pendingReminders.length}</span>}</button>
                                        {showReminderDropdown && pendingReminders.length > 0 && (<div className="absolute top-full right-0 mt-2 w-64 bg-slate-800 border border-blue-500/30 rounded-xl shadow-2xl p-2 z-50 animate-pop">{pendingReminders.map((r, idx) => (<div key={idx} onClick={() => handleReminderClick(idx)} className="p-3 hover:bg-white/10 rounded-lg cursor-pointer flex items-center gap-2 border-b border-white/5 last:border-0"><span className="text-lg">üîî</span><div className="text-xs text-left"><div className="font-bold text-blue-200">{r.text}</div></div></div>))}</div>)}
                                    </div>
                                    <div className="font-mono text-xs md:text-sm opacity-50 border border-white/10 px-2 py-1 rounded-full bg-black/20">{curTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                                </div>
                            </div>
                            <div className="space-y-2">
                                <Tooltip content="XP">
                                    <div className="cursor-help"><div className="flex justify-between text-[10px] font-bold opacity-40 uppercase tracking-widest"><span>Lv.{player.lv} XP</span><span>{Math.floor(player.xp)} / {maxExp}</span></div><div className="h-1.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-primary transition-all duration-700" style={{width:`${(player.xp/maxExp)*100}%`}} /></div></div>
                                </Tooltip>
                                <Tooltip content="Energy">
                                    <div className="cursor-help"><div className="flex justify-between text-[10px] font-bold opacity-40 uppercase tracking-widest text-orange-400"><span>Energy</span><span>{Math.floor(player.energy)} / {maxEnergy}</span></div><div className="h-1.5 bg-white/5 rounded-full overflow-hidden"><div className="h-full bg-orange-500 transition-all duration-700" style={{width:`${(player.energy/maxEnergy)*100}%`}} /></div></div>
                                </Tooltip>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 md:flex md:flex-col gap-2 w-full md:w-auto md:min-w-[140px]">
                            {['red', 'gold', 'purple'].map(type => (
                                <button key={type} onClick={() => usePotion(type)} className={`w-full flex justify-center md:justify-between p-2 rounded-lg text-[10px] font-bold border hover:brightness-125 ${type==='red'?'bg-red-500/10 border-red-500/20 text-red-400':type==='gold'?'bg-yellow-500/10 border-yellow-500/20 text-yellow-400':'bg-purple-500/10 border-purple-500/20 text-purple-400'}`}>
                                    <span className="hidden md:inline">{type==='red'?'üß™ ÁîüÂëΩ':type==='gold'?'üß™ ÈªûÈáë':'üß™ Ë≥¢ËÄÖ'}</span>
                                    <span className="md:hidden text-lg">üß™</span>
                                    <span>{player.potions[type]}</span>
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto mt-6 flex flex-col lg:grid lg:grid-cols-3 gap-6">
                        {/* 1. Input Section (Always top on mobile) */}
                        <div className="lg:col-span-1 lg:col-start-1 lg:row-start-1 order-1">
                             <div className="card p-4 rounded-2xl border-t-2 border-primary">
                                <h3 className="font-bold text-primary mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üìú ÂßîË®óÊó•Ë™å</span>
                                    <button onClick={() => setViewMode(viewMode === 'active' ? 'history' : 'active')} className={`text-[10px] px-2 py-1 rounded border transition-colors ${viewMode === 'history' ? 'bg-primary text-white border-transparent' : 'border-white/20 hover:border-white/50 text-white/50 hover:text-white'}`}>{viewMode === 'active' ? 'Ê≠∑Âè≤' : 'ÂßîË®ó'}</button>
                                </h3>
                                {viewMode === 'active' ? (
                                    <>
                                        <input value={input.text} onChange={e => setInput({...input, text: e.target.value})} className="w-full bg-black/30 p-3 rounded-xl mb-3 border border-white/5 outline-none focus:border-primary/50 text-sm" placeholder="ÂØ´‰∏ãÁõÆÊ®ô..." />
                                        <div className="flex gap-2 mb-3 bg-black/20 p-1 rounded-lg">
                                            <button onClick={() => setInput({ ...input, mode: 'duration' })} className={`flex-1 py-1 rounded text-xs font-bold transition-all ${input.mode === 'duration' ? 'bg-primary text-white' : 'text-white/30'}`}>ÊôÇÊï∏</button>
                                            <button onClick={() => setInput({ ...input, mode: 'date' })} className={`flex-1 py-1 rounded text-xs font-bold transition-all ${input.mode === 'date' ? 'bg-primary text-white' : 'text-white/30'}`}>Êó•Êúü</button>
                                        </div>
                                        {input.mode === 'duration' ? (
                                            <div className="grid grid-cols-4 gap-2 mb-4">
                                                {[1,2,4,6,12,24,72,168].map(h => <button key={h} onClick={()=>setInput({...input, hours:h})} className={`p-2 rounded text-[10px] border transition-all ${input.hours===h?'bg-primary border-primary':'border-white/5 opacity-30'}`}>{h}h</button>)}
                                            </div>
                                        ) : (
                                            <div className="mb-4 relative"><input type="datetime-local" className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-sm text-white outline-none focus:border-primary" onChange={(e) => setInput({ ...input, date: e.target.value })} /><div className="absolute right-3 top-3 pointer-events-none opacity-50"><Icon name="Calendar" /></div></div>
                                        )}
                                        <button onClick={handleAddTask} className="w-full bg-primary py-3 rounded-xl font-black shadow-lg hover:brightness-110 active:scale-95 transition-all text-sm">ÁôºÂ∏ÉÂ•ëÁ¥Ñ</button>
                                    </>
                                ) : (
                                    <div className="space-y-2 max-h-[300px] overflow-y-auto custom-scroll">
                                        {history.map(t => (
                                            <div key={t.id} className="card p-3 rounded-lg flex items-center gap-3 border-l-4 border-slate-600 opacity-60">
                                                <span className="text-lg grayscale">{t.icon}</span>
                                                <div className="flex-1"><div className="font-bold text-xs line-through">{t.content}</div></div>
                                            </div>
                                        ))}
                                        {history.length === 0 && <div className="text-center py-4 opacity-20 text-xs">ÁÑ°Á¥ÄÈåÑ</div>}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* 2. Tasks Section (Order 2 on mobile, Right col on desktop) */}
                        <section className="lg:col-span-2 lg:col-start-2 lg:row-start-1 lg:row-span-3 order-2 space-y-4">
                            {tasks.map(t => {
                                const remainingHours = Math.max(0, Math.floor((t.deadline - curTime)/3600000));
                                const isExpanded = expandedTaskId === t.id;
                                const completedSubtasks = t.subtasks ? t.subtasks.filter(st => st.completed).length : 0;
                                const totalSubtasks = t.subtasks ? t.subtasks.length : 0;
                                const bossHp = totalSubtasks > 0 ? ((totalSubtasks - completedSubtasks) / totalSubtasks) * 100 : (completedSubtasks > 0 ? 0 : 100);
                                return (
                                    <div key={t.id} className={`${t.isBoss ? "boss-card shadow-2xl scale-[1.01] border-2" : "card border-l-4 border-primary"} rounded-2xl transition-all overflow-hidden mb-3 ${activeAnim === t.id ? 'damage-shake' : ''}`}>
                                        <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-white/5" onClick={() => setExpandedTaskId(isExpanded ? null : t.id)}>
                                            <div className="flex-1 space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xl ${t.isBoss ? 'text-3xl boss-icon animate-bounce' : ''}`}>{t.icon || 'üìú'}</span>
                                                    <h4 className={`font-bold ${t.isBoss ? 'text-lg text-red-200' : 'text-base'}`}>{t.content}</h4>
                                                    {totalSubtasks > 0 && <span className="text-[10px] bg-primary/20 text-primary px-2 py-0.5 rounded-full">{completedSubtasks}/{totalSubtasks}</span>}
                                                </div>
                                                {t.isBoss && (<div className="w-full max-w-[200px] h-2 bg-black/50 rounded-full overflow-hidden border border-red-900/50"><div className="h-full bg-red-600 transition-all duration-300" style={{width: `${bossHp}%`}}></div></div>)}
                                                <div className="flex flex-wrap gap-2 text-[10px] font-bold opacity-60 uppercase tracking-widest">
                                                    <span className="bg-white/10 px-2 py-0.5 rounded text-white">{t.type}</span>
                                                    <span className={remainingHours < 3 ? 'text-red-400 animate-pulse' : ''}>‚è≥ {remainingHours}H</span>
                                                    <span className="text-yellow-500">${t.gold}</span>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 items-center">
                                                <button onClick={(e)=>{ e.stopPropagation(); setIsShaking(true); SoundEngine.play('fail'); setPlayer(p=>({...p, gold:Math.floor(p.gold*0.3), energy:Math.max(0,p.energy-60)})); setTasks(tasks.filter(tk=>tk.id!==t.id)); setTimeout(()=>setIsShaking(false),400); }} className="text-xs font-bold text-red-500/30 hover:text-red-500 p-2">ÊîæÊ£Ñ</button>
                                                {(!t.isBoss || totalSubtasks === 0 || completedSubtasks === totalSubtasks) && (
                                                    <button onClick={(e)=>{ e.stopPropagation(); setModalConfig({ type: 'complete_confirm', task: t }); }} className="bg-primary text-white px-4 py-2 rounded-xl font-black shadow-lg active:scale-95 text-xs">
                                                        {t.isBoss ? '‚öîÔ∏è Êñ¨ÊÆ∫' : 'ÂÆåÊàê'}
                                                    </button>
                                                )}
                                                <div className="opacity-50"><Icon name={isExpanded ? "ChevronUp" : "ChevronDown"} /></div>
                                            </div>
                                        </div>
                                        {isExpanded && (
                                            <div className="bg-black/20 p-4 border-t border-white/5">
                                                {t.isBoss && <div className="text-xs text-red-400 mb-2 font-bold text-center">ÊìäÁ†¥Âº±Èªû‰ª•ÂâäÊ∏õ BOSS ÁîüÂëΩÂÄºÔºÅ</div>}
                                                <div className="space-y-2 mb-3">
                                                    {t.subtasks && t.subtasks.map(st => (
                                                        <div key={st.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 group">
                                                            <button onClick={() => toggleSubtask(t.id, st.id)} className={`transition-colors ${st.completed ? 'text-primary' : 'text-white/20'}`}>{t.isBoss ? (st.completed ? <span className="text-lg">üí•</span> : <Icon name="Sword" size={18} className="text-red-400" />) : <Icon name={st.completed ? "CheckSquare" : "Square"} />}</button>
                                                            <span className={`flex-1 text-sm ${st.completed ? 'line-through opacity-30' : 'opacity-80'}`}>{st.text}</span>
                                                            <button onClick={() => removeSubtask(t.id, st.id)} className="text-red-400/50 hover:text-red-400"><Icon name="Trash2" size={14} /></button>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="flex gap-2">
                                                    <input type="text" placeholder={t.isBoss ? "Êñ∞Â¢ûÂº±Èªû..." : "Êñ∞Â¢ûÂ≠ê‰ªªÂãô..."} className="flex-1 bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary" onKeyDown={(e) => { if (e.key === 'Enter') { addSubtask(t.id, e.target.value); e.target.value = ''; } }} />
                                                    <button className="bg-white/10 hover:bg-primary px-3 rounded-lg" onClick={(e) => { const input = e.target.previousSibling; addSubtask(t.id, input.value); input.value = ''; }}><Icon name="Plus" size={16} /></button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                            {tasks.length === 0 && <div className="text-center py-20 opacity-20 font-bold text-xl">ÁõÆÂâç‰ΩàÂëäÊ¨ÑÁ©∫Á©∫Â¶Ç‰πü...</div>}
                        </section>

                        {/* 3. Base Section (Order 3 on mobile, Left col on desktop) */}
                        <div className="lg:col-span-1 lg:col-start-1 order-3">
                            <div className="card p-4 rounded-2xl border-l-4 border-green-600/50 relative overflow-hidden">
                                {player.lv < 9 && (<div className="absolute inset-0 bg-slate-900/90 z-20 flex flex-col items-center justify-center text-center p-4 backdrop-blur-sm"><Icon name="Lock" size={48} className="text-white/20 mb-2" /><h3 className="font-bold text-white text-lg">ÁßòÂØÜÂü∫Âú∞Êú™Ëß£Èéñ</h3><p className="text-white/50 text-xs mt-1">ÈúÄÁ≠âÁ¥ö 9</p></div>)}
                                <h3 className="font-bold text-green-500 mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üè° ÁßòÂØÜÂü∫Âú∞</span>
                                    <div className="flex gap-2"><button onClick={() => setModalConfig({type: 'collection'})} className="text-[10px] border border-white/20 px-2 py-1 rounded">ÂúñÈëë</button><BulkInput value={bulkAmount} onChange={setBulkAmount} /></div>
                                </h3>
                                <div className="space-y-4">
                                    <div className="bg-black/20 p-3 rounded-xl border border-white/5 relative">
                                        <div className="absolute top-2 right-2"><button onClick={()=>{setTempInput(player.base.treeName); setModalConfig({type:'rename_tree'})}} className="text-white/30 hover:text-white p-1"><Icon name="Edit3" size={12} /></button></div>
                                        <div className="flex items-center gap-3 mb-3">
                                            <div className={`text-4xl transition-transform ${activeAnim==='f'?'animate-pop':''}`}>{treeStage.icon}</div>
                                            <div className="flex-1"><div className="text-sm font-bold mb-1">{player.base.treeName} <span className="text-[10px] bg-green-900/50 px-1 rounded text-green-400">{treeStage.name}</span></div><div className="h-1.5 bg-white/10 rounded-full overflow-hidden"><div className="h-full bg-green-500 transition-all duration-1000" style={{width: `${player.base.treeProgress}%`}}></div></div></div>
                                        </div>
                                        {player.base.treeProgress >= 100 ? (<button onClick={harvestFruit} className="w-full bg-yellow-500 hover:bg-yellow-400 text-black py-2 rounded-lg font-black shadow-lg animate-bounce text-sm">üçé Êé°Êî∂</button>) : (<button onClick={()=>handleBaseAction('fertilize')} disabled={player.items.fertilizer<=0} className="w-full bg-green-600 hover:bg-green-500 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 active:scale-95"><span>üíß</span> ÊñΩËÇ• ({player.items.fertilizer})</button>)}
                                    </div>
                                    <div className="bg-black/20 p-3 rounded-xl border border-white/5 relative">
                                        <div className="absolute top-2 right-2"><button onClick={()=>{setTempInput(player.base.petName); setModalConfig({type:'rename_pet'})}} className="text-white/30 hover:text-white p-1"><Icon name="Edit3" size={12} /></button></div>
                                        <div className="flex items-center gap-3 mb-3">
                                            <div className={`text-4xl transition-transform ${activeAnim==='p'||activeAnim==='toy'?'animate-pop':''}`}>{petStage.icon}</div>
                                            <div className="flex-1">
                                                <div className="text-sm font-bold mb-1">{player.base.petName} <span className="text-[10px] bg-orange-900/50 px-1 rounded text-orange-400">{petStage.name}</span></div>
                                                <div className="flex gap-2 text-[10px] opacity-70"><span className={player.base.petHunger<30?'text-red-400':''}>È£Ω {player.base.petHunger}</span><span className={player.base.petMood<30?'text-blue-400':''}>ÂøÉ {player.base.petMood}</span></div>
                                            </div>
                                        </div>
                                        {player.base.petStatus === 'exploring' ? (
                                            <div className="text-center py-2 bg-white/5 rounded-lg text-xs animate-pulse">Êé¢Èö™‰∏≠... {player.base.adventureEndTime && <span className="block text-orange-400 mt-1">{formatTime(player.base.adventureEndTime - curTime.getTime())}</span>}</div>
                                        ) : player.base.petStatus === 'critical' ? (
                                            <button onClick={()=>treatPet('med_kit')} disabled={player.items.med_kit<=0} className="w-full bg-red-700 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs">üöë ÊÄ•Êïë</button>
                                        ) : player.base.petStatus === 'injured' ? (
                                            <button onClick={()=>treatPet('bandage')} disabled={player.items.bandage<=0} className="w-full bg-red-500/50 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs">ü©π ÂåÖÁ¥Æ</button>
                                        ) : (
                                            <div className="space-y-2">
                                                <div className="grid grid-cols-2 gap-2">
                                                    <button onClick={()=>handleBaseAction('feed')} disabled={player.items.food<=0} className="bg-orange-600 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs active:scale-95">ü•© È§µÈ£ü ({player.items.food})</button>
                                                    <button onClick={()=>setModalConfig({type:'adventure'})} className="bg-blue-600 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs active:scale-95">üéí Êé¢Èö™</button>
                                                </div>
                                                <button onClick={()=>handleBaseAction('toy')} disabled={player.items.toy<=0} className="w-full bg-pink-600 disabled:opacity-50 text-white py-2 rounded-lg font-bold text-xs active:scale-95">üß∂ Áé©ËÄç ({player.items.toy})</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* 4. Shop Section (Order 4 on mobile, Left col on desktop) */}
                        <div className="lg:col-span-1 lg:col-start-1 order-4">
                            <div className="card p-4 rounded-2xl border-l-4 border-yellow-600/50">
                                <h3 className="font-bold text-yellow-500 mb-4 text-xs uppercase tracking-widest flex justify-between items-center">
                                    <span>üõí ‰∫§ÊòìÊâÄ</span>
                                    <BulkInput value={bulkAmount} onChange={setBulkAmount} />
                                </h3>
                                <div className="space-y-2 max-h-[300px] overflow-y-auto pr-1 custom-scroll">
                                    {SHOP_ITEMS.map(item => (
                                        <button key={item.i} onClick={()=>shopBuy(item.i,item.t,item.c)} className="w-full flex justify-between bg-white/5 p-2 rounded-lg text-[11px] hover:bg-white/10 active:scale-95">
                                            <div className="text-left"><div>{item.n} (${item.c * (Number(bulkAmount)||1)})</div><div className="text-[9px] opacity-40">{item.desc}</div></div>
                                            <div>{item.t==='item'?player.items[item.i]:player.potions[item.i]}</div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>